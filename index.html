<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ªé˜³ç³»è¡Œæ˜Ÿå…¬è½¬æ¨¡æ‹Ÿ - 3Då®æ—¶</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --sun-color: #FDB813;
            --sun-glow: #FF6B35;
            --orbit-color: rgba(255, 255, 255, 0.15);
            --bg-deep: #0a0a1a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            background: var(--bg-deep);
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
            position: relative;
        }

        .cosmos {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(120, 50, 180, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(50, 100, 180, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(20, 20, 50, 1) 0%, var(--bg-deep) 100%);
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: var(--opacity); transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.8); }
        }

        .header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #fff 0%, #a8d4ff 50%, #fff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }

        .time-display {
            margin-top: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            color: #a8d4ff;
            text-shadow: 0 0 20px rgba(168, 212, 255, 0.5);
        }

        .date-display {
            margin-top: 5px;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 1px;
        }

        .lunar-display {
            margin-top: 6px;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.75);
            letter-spacing: 1px;
        }

        .bazi-display {
            margin-top: 6px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.85);
            letter-spacing: 1px;
            text-shadow: 0 0 16px rgba(168, 212, 255, 0.25);
        }

        .solar-system-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            perspective: 800px;
            width: 100vmin;
            height: 100vmin;
        }

        .solar-system {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            /* è§’åº¦æŠ¬èµ·ï¼šæ›´æ–¹ä¾¿è§‚å¯Ÿï¼ˆæ•°å€¼è¶Šå°è¶Šâ€œç«–â€ï¼‰ */
            transform: rotateX(40deg) rotateZ(-20deg);
        }

        .sun {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateZ(5px);
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 30% 30%, #FFF5E0 0%, var(--sun-color) 40%, var(--sun-glow) 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 60px var(--sun-color),
                0 0 100px var(--sun-glow),
                0 0 200px rgba(255, 107, 53, 0.4);
            animation: sunPulse 4s ease-in-out infinite;
            z-index: 100;
        }

        @keyframes sunPulse {
            0%, 100% { box-shadow: 0 0 60px var(--sun-color), 0 0 100px var(--sun-glow), 0 0 200px rgba(255, 107, 53, 0.4); }
            50% { box-shadow: 0 0 80px var(--sun-color), 0 0 130px var(--sun-glow), 0 0 250px rgba(255, 107, 53, 0.5); }
        }

        /* è½¨é“å¹³é¢ - åŒ…å«è½¨é“çº¿å’Œè¡Œæ˜Ÿ */
        .orbit-plane {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            transform-style: preserve-3d;
        }

        /* æ¤­åœ†è½¨é“çº¿ */
        .orbit-path {
            position: absolute;
            pointer-events: none;
        }

        /* è¡Œæ˜Ÿ */
        .planet {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: box-shadow 0.3s ease;
            z-index: 10;
        }

        .planet:hover {
            z-index: 200;
        }

        .planet-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) rotateX(-70deg) rotateZ(20deg);
            margin-top: 5px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            font-family: 'Noto Sans SC', sans-serif;
            text-shadow: 0 0 8px rgba(0,0,0,1);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .planet:hover .planet-label {
            opacity: 1;
        }

        /* è¡Œæ˜Ÿæ ·å¼ï¼ˆé¢œè‰²å–å¸¸è§â€œè§‚æµ‹å°è±¡â€è¿‘ä¼¼ï¼Œä¸è¿½æ±‚å¢å¼ºè‰²/ä¸¥æ ¼æµ‹å…‰ï¼‰ */
        .mercury { background: radial-gradient(circle at 30% 30%, #F0F0F0 0%, #A6A6A6 65%, #7E7E7E 100%); box-shadow: 0 0 8px rgba(180, 180, 180, 0.45); }
        .venus   { background: radial-gradient(circle at 30% 30%, #FFF7E6 0%, #E8D3A5 55%, #C9A66B 100%); box-shadow: 0 0 12px rgba(233, 208, 155, 0.40); }
        .earth   { background: radial-gradient(circle at 30% 30%, #BFE3FF 0%, #2B6CB0 55%, #1E7F4D 100%); box-shadow: 0 0 15px rgba(120, 180, 255, 0.45); }
        .mars    { background: radial-gradient(circle at 30% 30%, #F2A082 0%, #C85B2A 60%, #8F2F10 100%); box-shadow: 0 0 10px rgba(220, 110, 60, 0.35); }
        .jupiter { background: repeating-linear-gradient(0deg, #D9C3A7 0px, #C9A37A 2px, #E8D7C4 4px, #B7865C 6px); box-shadow: 0 0 25px rgba(215, 190, 160, 0.35); }
        .saturn  { background: radial-gradient(circle at 30% 30%, #FFF6DC 0%, #E6D3A8 55%, #CBB27D 100%); box-shadow: 0 0 20px rgba(235, 215, 160, 0.35); }
        .uranus  { background: radial-gradient(circle at 30% 30%, #D8FAFF 0%, #7FD8E6 55%, #49B4C7 100%); box-shadow: 0 0 15px rgba(120, 220, 230, 0.35); }
        .neptune { background: radial-gradient(circle at 30% 30%, #A8B7FF 0%, #3455D1 55%, #1D2E7A 100%); box-shadow: 0 0 15px rgba(90, 120, 255, 0.35); }
        .pluto   { background: radial-gradient(circle at 30% 30%, #EFE4D5 0%, #C7B3A0 55%, #8B786A 100%); box-shadow: 0 0 8px rgba(200, 180, 160, 0.30); }

        .saturn-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotateX(75deg);
            width: 200%;
            height: 200%;
            border: 3px solid rgba(200, 180, 140, 0.5);
            border-radius: 50%;
            pointer-events: none;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .control-btn {
            padding: 10px 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: rgba(100, 150, 255, 0.3);
            border-color: rgba(100, 150, 255, 0.6);
        }

        .speed-control {
            position: fixed;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            z-index: 100;
        }

        .speed-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .speed-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 120px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            transform: rotate(-90deg);
        }

        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #a8d4ff 0%, #6B93D6 100%);
            border-radius: 50%;
            cursor: pointer;
        }

        .speed-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: #6B93D6;
        }

        .info-panel {
            position: fixed;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(10, 10, 30, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 18px;
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 180px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .info-panel.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .info-panel h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: white;
        }

        .info-panel p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .info-panel .label {
            color: rgba(255, 255, 255, 0.5);
        }

        .legend {
            position: fixed;
            right: 25px;
            bottom: 25px;
            background: rgba(10, 10, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 15px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .legend-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .inclination-note {
            position: fixed;
            left: 25px;
            bottom: 25px;
            background: rgba(10, 10, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 15px;
            z-index: 100;
            backdrop-filter: blur(10px);
            max-width: 220px;
        }

        .inclination-note p {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
        }

        .inclination-note .highlight {
            color: #9E8B7E;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.3rem; }
            .time-display { font-size: 1rem; }
            .legend, .inclination-note { display: none; }
            .speed-control { right: 10px; }
            .info-panel { left: 10px; }
        }
    </style>
</head>
<body>
    <div class="cosmos"></div>
    <div class="stars" id="stars"></div>

    <header class="header">
        <h1>å¤ªé˜³ç³»è¡Œæ˜Ÿå…¬è½¬</h1>
        <div class="time-display" id="timeDisplay">00:00:00</div>
        <div class="date-display" id="dateDisplay">2026å¹´1æœˆ11æ—¥ æ˜ŸæœŸæ—¥</div>
        <div class="lunar-display" id="lunarDisplay">å†œå†ï¼š--</div>
        <div class="bazi-display" id="baziDisplay">å…«å­—ï¼š--</div>
    </header>

    <div class="solar-system-wrapper">
        <div class="solar-system" id="solarSystem">
            <div class="sun"></div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn active" id="playBtn">â–¶ è¿è¡Œ</button>
        <button class="control-btn" id="pauseBtn">â¸ æš‚åœ</button>
        <button class="control-btn" id="realTimeBtn">â—‰ å®æ—¶</button>
        <button class="control-btn active" id="toggleOrbitsBtn">â—¯ è½¨é“</button>
    </div>

    <div class="speed-control">
        <span class="speed-label">é€Ÿåº¦</span>
        <input type="range" class="speed-slider" id="speedSlider" min="0" max="6" step="0.1" value="3">
        <span class="speed-value" id="speedValue">1å¤©/ç§’</span>
    </div>

    <div class="info-panel" id="infoPanel">
        <h3 id="planetName">åœ°çƒ</h3>
        <p><span class="label">è·å¤ªé˜³:</span> <span id="planetDistance">1 AU</span></p>
        <p><span class="label">å…¬è½¬å‘¨æœŸ:</span> <span id="planetPeriod">365å¤©</span></p>
        <p><span class="label">è½¨é“ç¦»å¿ƒç‡:</span> <span id="planetEcc">0.017</span></p>
        <p><span class="label">è½¨é“å€¾è§’:</span> <span id="planetInc">0Â°</span></p>
    </div>

    <div class="legend">
        <div class="legend-title">è¡Œæ˜Ÿå›¾ä¾‹</div>
        <div class="legend-item"><div class="legend-dot" style="background: #A6A6A6;"></div>æ°´æ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #DABF8A;"></div>é‡‘æ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #2B6CB0;"></div>åœ°çƒ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #C85B2A;"></div>ç«æ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #C9A37A;"></div>æœ¨æ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #E6D3A8;"></div>åœŸæ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #7FD8E6;"></div>å¤©ç‹æ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #3455D1;"></div>æµ·ç‹æ˜Ÿ</div>
        <div class="legend-item"><div class="legend-dot" style="background: #C7B3A0;"></div>å†¥ç‹æ˜Ÿ</div>
    </div>

    <div class="inclination-note">
        <p>ğŸ”¸ è½¨é“ä¸ºæ¤­åœ†å½¢ï¼ŒåŸºäºçœŸå®ç¦»å¿ƒç‡</p>
        <p>ğŸ”¸ <span class="highlight">å†¥ç‹æ˜Ÿ</span>è½¨é“å€¾æ–œ17.16Â°</p>
        <p>ğŸ”¸ è¡Œæ˜Ÿä½ç½®åŸºäºJ2000å†å…ƒè®¡ç®—</p>
    </div>

    <!-- å†œå†/å…«å­—ï¼šä¼˜å…ˆä½¿ç”¨ lunisolarï¼ˆéœ€è¦è”ç½‘åŠ è½½ï¼‰ã€‚åŠ è½½å¤±è´¥ä¼šè‡ªåŠ¨é™çº§åˆ° Intl çš„å†œå†æ˜¾ç¤ºã€‚ -->
    <script src="https://cdn.jsdelivr.net/npm/lunisolar@2.0.0/dist/lunisolar.min.js"></script>

    <script>
        // è¡Œæ˜Ÿè½¨é“æ•°æ®ï¼ˆåŸºäºJ2000å†å…ƒï¼‰
        // å°ºå¯¸æŒ‰è¡Œæ˜ŸåŠå¾„â€œç›¸å¯¹å…³ç³»â€è®¾ç½®ä¸ºä¸€ç»„æ›´ç›´è§‚çš„åƒç´ å€¼ï¼ˆä¸åšä¸¥æ ¼æ¯”ä¾‹ç¼©æ”¾ï¼‰
        const planets = [
            { name: 'æ°´æ˜Ÿ', nameEn: 'Mercury', class: 'mercury', a: 0.387, e: 0.2056, i: 7.00, L0: 252.25, n: 4.0923, period: 88, size: 6 },
            { name: 'é‡‘æ˜Ÿ', nameEn: 'Venus', class: 'venus', a: 0.723, e: 0.0068, i: 3.39, L0: 181.98, n: 1.6021, period: 225, size: 9 },
            { name: 'åœ°çƒ', nameEn: 'Earth', class: 'earth', a: 1.000, e: 0.0167, i: 0.00, L0: 100.46, n: 0.9856, period: 365, size: 10 },
            { name: 'ç«æ˜Ÿ', nameEn: 'Mars', class: 'mars', a: 1.524, e: 0.0934, i: 1.85, L0: 355.45, n: 0.5240, period: 687, size: 7 },
            { name: 'æœ¨æ˜Ÿ', nameEn: 'Jupiter', class: 'jupiter', a: 5.203, e: 0.0485, i: 1.31, L0: 34.40, n: 0.0831, period: 4333, size: 24 },
            { name: 'åœŸæ˜Ÿ', nameEn: 'Saturn', class: 'saturn', a: 9.537, e: 0.0556, i: 2.49, L0: 50.08, n: 0.0335, period: 10759, size: 20, hasRing: true },
            { name: 'å¤©ç‹æ˜Ÿ', nameEn: 'Uranus', class: 'uranus', a: 19.19, e: 0.0472, i: 0.77, L0: 314.20, n: 0.0117, period: 30687, size: 14 },
            { name: 'æµ·ç‹æ˜Ÿ', nameEn: 'Neptune', class: 'neptune', a: 30.07, e: 0.0086, i: 1.77, L0: 304.22, n: 0.0060, period: 60190, size: 14 },
            { name: 'å†¥ç‹æ˜Ÿ', nameEn: 'Pluto', class: 'pluto', a: 39.48, e: 0.2488, i: 17.16, L0: 238.96, n: 0.00397, period: 90560, size: 6 }
        ];

        // J2000å†å…ƒ
        const J2000 = new Date(Date.UTC(2000, 0, 1, 12, 0, 0));
        
        // è½¨é“æ¯”ä¾‹å‚æ•°
        const MIN_ORBIT = 45; // pxï¼Œå†…åœˆæœ€å°åŠé•¿è½´
        const ORBIT_MARGIN = 70; // pxï¼Œç»™UI/å¤ªé˜³ç•™è¾¹è·
        let orbitScaleK = 1; // pxï¼Œlog(a+1) çš„ç¼©æ”¾ç³»æ•°ï¼ˆä¼šæ ¹æ®å±å¹•è‡ªé€‚åº”ï¼‰

        // çŠ¶æ€
        let isRunning = true;
        let isRealTime = false;
        let showOrbits = true;
        let simulatedDate = new Date();
        let lastTime = performance.now();

        // DOMå…ƒç´ 
        const solarSystem = document.getElementById('solarSystem');
        const solarSystemWrapper = document.querySelector('.solar-system-wrapper');
        const timeDisplay = document.getElementById('timeDisplay');
        const dateDisplay = document.getElementById('dateDisplay');
        const lunarDisplay = document.getElementById('lunarDisplay');
        const baziDisplay = document.getElementById('baziDisplay');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const infoPanel = document.getElementById('infoPanel');

        // ç”Ÿæˆæ˜Ÿæ˜Ÿ
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--opacity', Math.random() * 0.5 + 0.5);
                star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
                star.style.animationDelay = `${Math.random() * 3}s`;
                starsContainer.appendChild(star);
            }
        }

        // è®¡ç®—å±å¹•åŠé•¿è½´ï¼ˆä½¿ç”¨å¯¹æ•°ç¼©æ”¾ï¼‰
        function getScreenSemiMajorAxis(a) {
            return MIN_ORBIT + Math.log(a + 1) * orbitScaleK;
        }

        // æ ¹æ®å½“å‰çª—å£å°ºå¯¸è‡ªé€‚åº”ç¼©æ”¾ï¼Œç¡®ä¿æœ€å¤–åœˆï¼ˆå†¥ç‹æ˜Ÿï¼‰ä¹Ÿåœ¨è§†å£å†…
        function computeOrbitScale() {
            const rect = (solarSystemWrapper ?? solarSystem).getBoundingClientRect();
            const maxRadius = Math.max(120, Math.min(rect.width, rect.height) / 2 - ORBIT_MARGIN);
            const maxA = Math.max(...planets.map(p => p.a));
            const maxE = Math.max(...planets.map(p => p.e));
            const baseMax = Math.log(maxA + 1);

            // æœ€å¤–åœˆåœ¨xæ–¹å‘æœ€å¤§ä¼¸å±•çº¦ä¸º a*(1+e)ï¼Œå› æ­¤éœ€è¦ä¿è¯ a_screen*(1+e_max) <= maxRadius
            const maxAScreen = maxRadius / (1 + maxE);
            const k = (maxAScreen - MIN_ORBIT) / (baseMax || 1);
            orbitScaleK = Math.max(20, k); // é˜²æ­¢è¿‡å°å¯¼è‡´å†…åœˆæŒ¤åœ¨ä¸€èµ·
        }

        // ä»J2000ä»¥æ¥çš„å¤©æ•°
        function daysSinceJ2000(date) {
            return (date.getTime() - J2000.getTime()) / (1000 * 60 * 60 * 24);
        }

        function formatDateTimeForLib(date) {
            const yyyy = date.getFullYear();
            const MM = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const HH = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            const ss = String(date.getSeconds()).padStart(2, '0');
            return `${yyyy}-${MM}-${dd} ${HH}:${mm}:${ss}`;
        }

        function getLunisolar(date) {
            const fn = (typeof window.lunisolar === 'function')
                ? window.lunisolar
                : (window.lunisolar && typeof window.lunisolar.default === 'function')
                    ? window.lunisolar.default
                    : null;
            if (!fn) return null;
            try { return fn(date); } catch (_) { /* ignore */ }
            try { return fn(formatDateTimeForLib(date)); } catch (_) { /* ignore */ }
            return null;
        }

        function getLunarTextFallback(date) {
            try {
                const fmt = new Intl.DateTimeFormat('zh-CN-u-ca-chinese', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                // åœ¨éƒ¨åˆ†æµè§ˆå™¨é‡Œï¼Œyear ä¼šæ˜¯ relatedYearï¼ˆå†œå†å¹´ï¼‰ï¼Œmonth/day ä¼šå¸¦ä¸­æ–‡
                return fmt.format(date);
            } catch (_) {
                return '--';
            }
        }

        function updateLunarAndBaZi(date) {
            // 1) å†œå†æ˜¾ç¤ºï¼šä¼˜å…ˆç”¨ lunisolar çš„å®Œæ•´è¡¨è¾¾
            const ls = getLunisolar(date);
            let lunarText = null;
            let baziText = null;

            if (ls) {
                try {
                    if (ls.lunar && typeof ls.lunar.toString === 'function') {
                        lunarText = ls.lunar.toString();
                    }
                } catch (_) { /* ignore */ }

                try {
                    if (typeof ls.format === 'function') {
                        // å¹´æŸ± æœˆæŸ± æ—¥æŸ± æ—¶æŸ±ï¼ˆå››æŸ±å…«å­—ï¼‰
                        const pillars = ls.format('cY cM cD cH');
                        baziText = pillars;
                    } else if (ls.char8) {
                        baziText = (typeof ls.char8.toString === 'function') ? ls.char8.toString() : String(ls.char8);
                    }
                } catch (_) { /* ignore */ }
            }

            if (!lunarText) {
                lunarText = getLunarTextFallback(date);
            }
            lunarDisplay.textContent = `å†œå†ï¼š${lunarText}`;

            if (baziText) {
                baziDisplay.textContent = `å…«å­—ï¼š${baziText}`;
            } else {
                baziDisplay.textContent = 'å…«å­—ï¼šåŠ è½½å†æ³•åº“å¤±è´¥ï¼ˆéœ€è”ç½‘ï¼‰';
            }
        }

        // å¼€æ™®å‹’æ–¹ç¨‹æ±‚è§£åè¿‘ç‚¹è§’ï¼ˆç‰›é¡¿è¿­ä»£æ³•ï¼‰
        function solveKepler(M, e, tolerance = 1e-8) {
            let E = M;
            for (let i = 0; i < 30; i++) {
                const dE = (E - e * Math.sin(E) - M) / (1 - e * Math.cos(E));
                E -= dE;
                if (Math.abs(dE) < tolerance) break;
            }
            return E;
        }

        // è®¡ç®—è¡Œæ˜Ÿåœ¨è½¨é“ä¸Šçš„ä½ç½®ï¼ˆè¿”å›å±å¹•åæ ‡ï¼‰
        function getPlanetScreenPosition(planet, date) {
            const days = daysSinceJ2000(date);
            
            // å¹³å‡è¿‘ç‚¹è§’ï¼ˆå¼§åº¦ï¼‰
            const M = ((planet.L0 + planet.n * days) % 360) * Math.PI / 180;
            
            // æ±‚è§£åè¿‘ç‚¹è§’
            const E = solveKepler(M, planet.e);
            
            // å±å¹•åŠé•¿è½´å’ŒåŠçŸ­è½´
            const a_screen = getScreenSemiMajorAxis(planet.a);
            const b_screen = a_screen * Math.sqrt(1 - planet.e * planet.e);
            
            // æ¤­åœ†å‚æ•°æ–¹ç¨‹ï¼ˆä»¥æ¤­åœ†ä¸­å¿ƒä¸ºåŸç‚¹ï¼‰
            const x_center = a_screen * Math.cos(E);
            const y_center = b_screen * Math.sin(E);
            
            // è½¬æ¢åˆ°ä»¥ç„¦ç‚¹ï¼ˆå¤ªé˜³ï¼‰ä¸ºåŸç‚¹çš„åæ ‡
            // ç„¦ç‚¹åœ¨æ¤­åœ†ä¸­å¿ƒçš„å³ä¾§ c = a*e å¤„ï¼Œæ‰€ä»¥æ¤­åœ†ä¸­å¿ƒç›¸å¯¹äºç„¦ç‚¹åœ¨ -c å¤„
            const c = a_screen * planet.e;
            const x = x_center - c;  // ç›¸å¯¹äºå¤ªé˜³ï¼ˆç„¦ç‚¹ï¼‰çš„xåæ ‡
            const y = y_center;
            
            // è®¡ç®—å½“å‰æ—¥å¿ƒè·ç¦»ï¼ˆç”¨äºä¿¡æ¯æ˜¾ç¤ºï¼‰
            const r_AU = planet.a * (1 - planet.e * Math.cos(E));
            
            return { x, y, r: r_AU, E };
        }

        // åˆ›å»ºè½¨é“å¹³é¢ï¼ˆåŒ…å«è½¨é“çº¿å’Œè¡Œæ˜Ÿï¼‰
        function createOrbitPlane(planet) {
            const a_screen = getScreenSemiMajorAxis(planet.a);
            const b_screen = a_screen * Math.sqrt(1 - planet.e * planet.e);
            const c = a_screen * planet.e;
            
            // è½¨é“å¹³é¢å®¹å™¨
            const plane = document.createElement('div');
            plane.className = 'orbit-plane';
            plane.id = `orbit-plane-${planet.class}`;
            plane.style.transform = `rotateX(${planet.i}deg)`;
            
            // åˆ›å»ºæ¤­åœ†è½¨é“SVG
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            const padding = 5;
            const width = a_screen * 2 + padding * 2;
            const height = b_screen * 2 + padding * 2;
            
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('class', 'orbit-path');
            svg.style.left = `${-a_screen - padding - c}px`;  // æ¤­åœ†ä¸­å¿ƒåœ¨ -cï¼Œå·¦è¾¹ç¼˜å†å‡ a+padding
            svg.style.top = `${-b_screen - padding}px`;
            
            const ellipse = document.createElementNS(svgNS, 'ellipse');
            ellipse.setAttribute('cx', a_screen + padding);
            ellipse.setAttribute('cy', b_screen + padding);
            ellipse.setAttribute('rx', a_screen);
            ellipse.setAttribute('ry', b_screen);
            ellipse.setAttribute('fill', 'none');
            ellipse.setAttribute('stroke', 'rgba(255, 255, 255, 0.15)');
            ellipse.setAttribute('stroke-width', '1');
            
            svg.appendChild(ellipse);
            plane.appendChild(svg);
            
            // åˆ›å»ºè¡Œæ˜Ÿ
            const planetEl = document.createElement('div');
            planetEl.className = `planet ${planet.class}`;
            planetEl.id = `planet-${planet.class}`;
            planetEl.style.width = `${planet.size}px`;
            planetEl.style.height = `${planet.size}px`;
            planetEl.style.marginLeft = `${-planet.size / 2}px`;
            planetEl.style.marginTop = `${-planet.size / 2}px`;
            
            // è¡Œæ˜Ÿæ ‡ç­¾
            const label = document.createElement('div');
            label.className = 'planet-label';
            label.textContent = planet.name;
            planetEl.appendChild(label);
            
            // åœŸæ˜Ÿå…‰ç¯
            if (planet.hasRing) {
                const ring = document.createElement('div');
                ring.className = 'saturn-ring';
                planetEl.appendChild(ring);
            }
            
            // ç‚¹å‡»æ˜¾ç¤ºä¿¡æ¯
            planetEl.addEventListener('click', () => showPlanetInfo(planet));
            planetEl.addEventListener('mouseenter', () => showPlanetInfo(planet));
            
            plane.appendChild(planetEl);
            
            return plane;
        }

        // åˆå§‹åŒ–å¤ªé˜³ç³»
        function createSolarSystem() {
            planets.forEach(planet => {
                const plane = createOrbitPlane(planet);
                solarSystem.appendChild(plane);
            });
        }

        function rebuildSolarSystem() {
            // ä¿ç•™å¤ªé˜³ï¼Œåªé‡å»ºå„è¡Œæ˜Ÿçš„è½¨é“å¹³é¢
            document.querySelectorAll('.orbit-plane').forEach(el => el.remove());
            computeOrbitScale();
            createSolarSystem();
            updatePlanets(simulatedDate);

            // ç»´æŒå½“å‰è½¨é“æ˜¾éšçŠ¶æ€
            document.querySelectorAll('.orbit-path').forEach(orbit => {
                orbit.style.opacity = showOrbits ? '1' : '0';
            });
        }

        // æ›´æ–°è¡Œæ˜Ÿä½ç½®
        function updatePlanets(date) {
            planets.forEach(planet => {
                const pos = getPlanetScreenPosition(planet, date);
                const planetEl = document.getElementById(`planet-${planet.class}`);
                
                if (planetEl) {
                    // è¡Œæ˜Ÿåœ¨è½¨é“å¹³é¢å†…ç§»åŠ¨ï¼Œåªéœ€è¦xå’Œy
                    planetEl.style.left = `${pos.x}px`;
                    planetEl.style.top = `${pos.y}px`;
                }
            });
        }

        // æ˜¾ç¤ºè¡Œæ˜Ÿä¿¡æ¯
        function showPlanetInfo(planet) {
            const pos = getPlanetScreenPosition(planet, simulatedDate);
            
            document.getElementById('planetName').textContent = `${planet.name} ${planet.nameEn}`;
            document.getElementById('planetDistance').textContent = `${pos.r.toFixed(3)} AU`;
            document.getElementById('planetPeriod').textContent = `${planet.period}å¤©`;
            document.getElementById('planetEcc').textContent = planet.e.toFixed(4);
            document.getElementById('planetInc').textContent = `${planet.i.toFixed(2)}Â°`;
            
            infoPanel.classList.add('visible');
            
            clearTimeout(infoPanel.hideTimeout);
            infoPanel.hideTimeout = setTimeout(() => {
                infoPanel.classList.remove('visible');
            }, 4000);
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            timeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            dateDisplay.textContent = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${weekdays[date.getDay()]}`;
        }

        // é€Ÿåº¦æ–‡æœ¬
        function getSpeedText(value) {
            if (value === 0) return 'æš‚åœ';
            if (value <= 1) return `${value.toFixed(1)}å¤©/ç§’`;
            if (value <= 2) return `${Math.round(value)}å¤©/ç§’`;
            if (value <= 3) return `${Math.round(value * 7)}å¤©/ç§’`;
            if (value <= 4) return `${Math.round((value - 2) * 30)}å¤©/ç§’`;
            if (value <= 5) return `${Math.round((value - 3) * 180)}å¤©/ç§’`;
            return `${Math.round((value - 4) * 365)}å¤©/ç§’`;
        }

        // å¤©æ•°/ç§’
        function getDaysPerSecond(value) {
            if (value <= 1) return value;
            if (value <= 2) return value;
            if (value <= 3) return value * 7;
            if (value <= 4) return (value - 2) * 30;
            if (value <= 5) return (value - 3) * 180;
            return (value - 4) * 365;
        }

        // åŠ¨ç”»å¾ªç¯
        function animate(currentTime) {
            const deltaTime = Math.min(currentTime - lastTime, 100); // é™åˆ¶æœ€å¤§å¸§é—´éš”
            lastTime = currentTime;
            
            if (isRealTime) {
                simulatedDate = new Date();
            } else if (isRunning) {
                const daysToAdd = getDaysPerSecond(parseFloat(speedSlider.value)) * (deltaTime / 1000);
                simulatedDate = new Date(simulatedDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            }
            
            updatePlanets(simulatedDate);
            updateTimeDisplay(simulatedDate);

            // å†œå†/å…«å­—ä¸éœ€è¦æ¯å¸§æ›´æ–°ï¼ŒæŒ‰â€œç§’â€èŠ‚æµ
            const key = formatDateTimeForLib(simulatedDate);
            if (key !== animate._lastKey) {
                animate._lastKey = key;
                updateLunarAndBaZi(simulatedDate);
            }
            
            requestAnimationFrame(animate);
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('playBtn').addEventListener('click', function() {
            isRunning = true;
            isRealTime = false;
            this.classList.add('active');
            document.getElementById('pauseBtn').classList.remove('active');
            document.getElementById('realTimeBtn').classList.remove('active');
        });

        document.getElementById('pauseBtn').addEventListener('click', function() {
            isRunning = false;
            isRealTime = false;
            this.classList.add('active');
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('realTimeBtn').classList.remove('active');
        });

        document.getElementById('realTimeBtn').addEventListener('click', function() {
            isRealTime = true;
            isRunning = false;
            this.classList.add('active');
            document.getElementById('playBtn').classList.remove('active');
            document.getElementById('pauseBtn').classList.remove('active');
            simulatedDate = new Date();
        });

        document.getElementById('toggleOrbitsBtn').addEventListener('click', function() {
            showOrbits = !showOrbits;
            this.classList.toggle('active', showOrbits);
            document.querySelectorAll('.orbit-path').forEach(orbit => {
                orbit.style.opacity = showOrbits ? '1' : '0';
            });
        });

        speedSlider.addEventListener('input', (e) => {
            speedValue.textContent = getSpeedText(parseFloat(e.target.value));
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.planet') && !e.target.closest('.info-panel')) {
                infoPanel.classList.remove('visible');
            }
        });

        // çª—å£å°ºå¯¸å˜åŒ–æ—¶è‡ªé€‚åº”ç¼©æ”¾ï¼Œç¡®ä¿å†¥ç‹æ˜Ÿä¹Ÿåœ¨è§†å£å†…
        let resizeRaf = 0;
        window.addEventListener('resize', () => {
            if (resizeRaf) cancelAnimationFrame(resizeRaf);
            resizeRaf = requestAnimationFrame(() => {
                resizeRaf = 0;
                rebuildSolarSystem();
            });
        });

        // åˆå§‹åŒ–
        createStars();
        simulatedDate = new Date();
        computeOrbitScale();
        createSolarSystem();
        updatePlanets(simulatedDate);
        speedValue.textContent = getSpeedText(3);
        requestAnimationFrame(animate);
    </script>
</body>
</html>
